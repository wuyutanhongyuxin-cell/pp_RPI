# RPI Bot - Paradex 智能交易机器人

<p align="center">
  <img src="https://img.shields.io/badge/Python-3.8+-blue.svg" alt="Python">
  <img src="https://img.shields.io/badge/Platform-Paradex-green.svg" alt="Platform">
  <img src="https://img.shields.io/badge/License-MIT-yellow.svg" alt="License">
  <img src="https://img.shields.io/badge/Version-2.0-red.svg" alt="Version">
</p>

一个基于研究优化的 Paradex 永续合约交易机器人，集成了多种专业量化交易策略。

## 核心特性

| 特性 | 描述 |
|------|------|
| **RPI 触发** | 100% 使用市价单(TAKER)，最大化 RPI 获取 |
| **零手续费** | 配合 Interactive Token 实现 0% 交易手续费 |
| **智能平仓** | POST_ONLY 限价单平仓，赚取点差而非支付 |
| **方向预测** | 基于订单簿不平衡度预测短期价格方向 |
| **Kelly仓位** | 动态仓位管理，科学控制风险 |
| **时段过滤** | 避开低流动性时段，提高胜率 |
| **回撤控制** | 自动暂停机制，保护本金安全 |

---

## v2.0 研究优化版 - 新增功能

### 策略原理升级

```
传统方法 (v1.0):
  市价买入 (支付点差) -> 等待 -> 市价卖出 (支付点差)
  = 每笔交易支付 2 次点差成本

研究优化 (v2.0):
  市价买入 (支付点差, 获得RPI) -> 等待 -> 限价卖出 (赚取点差)
  = 只支付 1 次点差，可能赚取 1 次点差
```

### 风险收益比策略

使用 1:2 的风险收益比，大幅降低盈亏平衡所需的胜率：

| 风险收益比 | 所需胜率 | 说明 |
|-----------|---------|------|
| 1:1 | 50%+ | 传统策略 |
| **1:2** | **33%+** | 本策略默认 |
| 1:3 | 25%+ | 激进设置 |

### 订单簿方向信号

```python
imbalance = (买方挂单量 - 卖方挂单量) / (买方挂单量 + 卖方挂单量)

imbalance > +0.3  →  买压大，做多信号
imbalance < -0.3  →  卖压大，跳过交易
```

---

## 快速开始

### 1. 环境准备

```bash
# 克隆项目
git clone https://github.com/wuyutanhongyuxin-cell/pp_RPI.git
cd pp_RPI

# 创建虚拟环境 (推荐)
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# 或 .\venv\Scripts\activate  # Windows

# 安装依赖
pip install -r requirements.txt
```

### 2. 配置账号

```bash
# 复制配置模板
cp .env.example .env

# 编辑配置文件
nano .env
```

#### 单账号配置

```ini
PARADEX_L2_PRIVATE_KEY=0x你的L2私钥
PARADEX_L2_ADDRESS=0x你的L2地址
```

#### 多账号配置 (推荐)

当一个账号达到交易限制时，自动切换到下一个账号:

```ini
PARADEX_ACCOUNTS=0x私钥1,0x地址1;0x私钥2,0x地址2;0x私钥3,0x地址3
```

### 3. 运行脚本

```bash
python rpi_bot.py
```

## 配置说明

### 基础配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `MARKET` | BTC-USD-PERP | 交易市场 |
| `TRADE_SIZE` | 0.001 | 每笔交易大小 (BTC) |
| `TRADE_INTERVAL` | 3.0 | 交易间隔 (秒) |
| `PARADEX_ENVIRONMENT` | prod | 环境 (prod/testnet) |

### 研究优化参数 (v2.0 新增)

| 参数 | 默认值 | 说明 |
|------|-------|------|
| `EXIT_ORDER_TYPE` | `limit` | 平仓模式: `limit`=限价单(赚点差), `market`=市价单 |
| `DIRECTION_SIGNAL_THRESHOLD` | `0.3` | 方向信号阈值，订单簿不平衡度超过此值才入场 |
| `RISK_REWARD_RATIO` | `2.0` | 风险收益比，止盈=止损×此值 |
| `TIME_FILTER` | `true` | 时段过滤开关 |
| `OPTIMAL_HOURS_START` | `8` | 最佳时段开始 (UTC) |
| `OPTIMAL_HOURS_END` | `21` | 最佳时段结束 (UTC) |
| `WEEKEND_MULTIPLIER` | `0.5` | 周末仓位乘数 |
| `KELLY_ENABLED` | `true` | Kelly仓位管理开关 |
| `KELLY_FRACTION` | `0.25` | Kelly分数 (1/4 Kelly) |
| `MAX_POSITION_PCT` | `0.20` | 最大仓位占比 |
| `DRAWDOWN_CONTROL` | `true` | 回撤控制开关 |
| `MAX_DAILY_LOSS_PCT` | `0.03` | 日内最大亏损 (3%) |
| `MAX_TOTAL_LOSS_PCT` | `0.10` | 总体最大亏损 (10%) |

### 风控参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `MAX_SPREAD_PCT` | 0.012 | 最大允许价差 |
| `STOP_LOSS_PCT` | 0.015 | 止损百分比 |
| `MAX_WAIT_SECONDS` | 15 | 等待止盈最长时间 |
| `CHECK_INTERVAL` | 0.3 | 价格检查间隔 |

## 如何获取 L2 私钥和地址

### 方法1: 从 Paradex 网页端导出

1. 登录 [Paradex](https://app.paradex.trade/)
2. 点击右上角钱包图标
3. 选择 "Export Private Key"
4. 输入密码验证
5. 复制显示的私钥和地址

### 方法2: 使用 Starknet 钱包

如果你使用 Argent X 或 Braavos 钱包:

1. 打开钱包扩展
2. 进入设置 -> 安全
3. 导出私钥

## 运行示例

```
14:30:25 [INFO] ============================================================
14:30:25 [INFO] RPI Bot - 100% RPI 触发交易机器人
14:30:25 [INFO] ============================================================
14:30:25 [INFO] 市场: BTC-USD-PERP
14:30:25 [INFO] 交易大小: 0.003 BTC
14:30:25 [INFO] 交易间隔: 2.0 秒
14:30:25 [INFO]
14:30:25 [INFO] 核心原理:
14:30:25 [INFO]   - 只使用市价单 (TAKER) = 100% RPI
14:30:25 [INFO]   - Interactive Token = 0% 手续费
14:30:25 [INFO]   - 快速开平仓循环
14:30:25 [INFO] ============================================================
14:30:26 [INFO] 认证成功! token_usage=interactive
14:30:26 [INFO] 认证成功，开始 RPI 交易...
14:30:26 [INFO]
14:30:26 [INFO] [开仓] 市价买入 0.003 BTC...
14:30:27 [INFO] 市价单成功: BUY 0.003 BTC, order_id=xxx
14:30:27 [INFO]   -> RPI 获得! flags=['interactive', 'rpi']
14:30:27 [INFO] [平仓] 市价卖出 0.003 BTC...
14:30:28 [INFO] 市价单成功: SELL 0.003 BTC, order_id=xxx
14:30:28 [INFO]   -> RPI 获得! flags=['interactive', 'rpi']
14:30:28 [INFO] [统计] 总交易: 2, RPI: 2 (100.0%)
```

## 安全退出

按 `Ctrl+C` 可以安全退出，脚本会:

1. 取消所有未完成的挂单
2. 平掉所有持仓
3. 保存账号状态

---

## 策略模块详解 (v2.0)

### 1. 时段过滤 (Time Filter)

基于研究发现，加密货币市场在不同时段的流动性差异显著：

| 时段 (UTC) | 流动性 | 策略 |
|-----------|-------|------|
| 08:00-12:00 | 中高 | 正常交易 (80%仓位) |
| **13:00-17:00** | **最高** | **黄金时段 (100%仓位)** |
| 17:00-21:00 | 中 | 正常交易 (80%仓位) |
| 21:00-08:00 | 低 | 暂停交易 |
| 周末 | 低30% | 减半仓位 (50%) |

### 2. Kelly 准则仓位管理

Kelly 公式自动根据历史胜率和盈亏比计算最优仓位：

```
f* = (bp - q) / b

其中:
- b = 平均盈利 / 平均亏损
- p = 胜率
- q = 1 - p
```

使用 1/4 Kelly 以降低回撤风险。

### 3. 回撤控制

自动监控账户回撤，超限时暂停交易：

- **日内回撤 > 3%**: 暂停交易至次日
- **总体回撤 > 10%**: 暂停交易，需手动重启

### 4. POST_ONLY 限价单平仓

止盈和超时平仓时使用 POST_ONLY 限价单：

- 作为 Maker 可能获得返佣
- 不会产生滑点
- 在买一价挂单，相当于"赚取"点差
- 止损时仍使用市价单，确保快速出场

---

## 运行日志示例 (v2.0)

```
12:34:56 [INFO] [周期] 开始 RPI 交易周期...
12:34:56 [INFO] [时段] 黄金时段
12:34:56 [INFO] [检查] 余额: 1000.00 USDC
12:34:56 [INFO] [检查] Spread: $5.20 (0.0052%) | 限制: 0.012%
12:34:57 [INFO] [订单簿] 不平衡度: 0.42 | 方向: LONG | 置信度: 0.42
12:34:57 [INFO] [入场] 趋势上涨+买压: +$12.00, imb=0.42
12:34:57 [INFO] [风险收益] 止盈=0.030% : 止损=0.015% (R/R=2.0)
12:34:57 [INFO] [开仓] 市价买入 0.001 BTC @ ~$100005.2...
12:34:57 [INFO]   -> RPI! flags=['rpi']
12:34:57 [INFO] [等待] 止盈: $100035.2 (+0.030%) | 止损: $99990.2 (-0.015%)
12:35:05 [INFO] [止盈] $100038.5 >= $100035.2
12:35:05 [INFO] [平仓] 限价单卖出 0.001 BTC @ $100038.5 (POST_ONLY)...
12:35:06 [INFO]   -> 限价单成交 @ $100038.5
12:35:06 [INFO]   -> PnL: $0.0333 (+0.0333%) | 出场: take_profit
12:35:06 [INFO] [统计] 交易: 42 | RPI: 42 (100.0%) | 胜率: 52.4% | 累计PnL: $0.8521
```

---

## 性能预期

| 指标 | v1.0 | v2.0 优化后 |
|-----|-------|------------|
| 胜率要求 | ~57% | ~33% |
| 实际胜率 | 30-45% | 45-55% |
| 风险收益比 | ~1:1 | 1:2 |
| 点差成本 | 每次支付 | 可能赚取 |
| 期望值/交易 | 负 | 正 |

---

## 多账号轮换机制

当使用多账号配置时:

- 每个账号每小时最多 300 笔交易
- 每个账号每天最多 1000 笔交易
- 当前账号达到限制时自动切换到下一个可用账号
- 所有账号状态自动保存，重启后继续

## 常见问题

### Q: 为什么我的 RPI 率不是 100%?

A: RPI 不是每笔 TAKER 订单都会给，约 20-50% 的 TAKER 订单会获得 RPI。本脚本保证所有订单都是 TAKER (有 RPI 资格)，但具体是否触发取决于 Paradex 的内部算法。

### Q: 手续费真的是 0% 吗?

A: 是的，使用 `?token_usage=interactive` 认证后，所有订单的 maker/taker 费率都是 0%。

### Q: 为什么选择 0.003 BTC?

A: 根据历史数据分析，0.002-0.003 BTC 区间的订单 RPI 触发率约 53%，高于其他大小。

### Q: 脚本运行时突然断开怎么办?

A: 重新运行脚本即可。脚本会自动:
- 加载之前保存的账号状态
- 清理残留的挂单和仓位
- 继续 RPI 交易

---

## 更新日志

### v2.0 (2024-02-04) - 研究优化版

**新增功能:**
- POST_ONLY 限价单平仓功能 - 赚取点差而非支付
- 订单簿方向信号预测 - 基于买卖压不平衡度
- Kelly 准则仓位管理 - 科学动态调整仓位
- 时段过滤器 - 避开低流动性时段
- 回撤控制机制 - 自动暂停保护本金
- 风险收益比配置 - 支持自定义止盈止损比例

**优化:**
- 入场信号判断逻辑升级
- 新增实时胜率和累计PnL统计
- 配置参数大幅扩展

### v1.0 - 初始版本

- 基础 RPI 交易功能
- 趋势过滤
- 动态止损
- 多账号轮换

---

## 风险提示

1. **市场风险**: 加密货币市场波动剧烈，可能产生超出预期的亏损
2. **策略风险**: 历史表现不代表未来收益，策略可能在某些市场条件下失效
3. **技术风险**: 网络延迟、API故障等可能影响交易执行
4. **资金管理**: 建议使用小资金测试，确认稳定后再增加交易量

## 免责声明

- 本脚本仅供学习和研究使用
- 加密货币交易存在风险，请谨慎使用
- 作者不对使用本脚本造成的任何损失负责

## 相关项目

- [pp2](https://github.com/wuyutanhongyuxin-cell/pp2) - 原版 Paradex 狙击机器人

## License

MIT

---

<p align="center">
  <b>如果这个项目对你有帮助，请给个 Star 支持一下！</b>
</p>
