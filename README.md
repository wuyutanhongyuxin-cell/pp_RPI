# RPI Bot v2.1 - Paradex 智能交易机器人

<p align="center">
  <img src="https://img.shields.io/badge/Python-3.8+-blue.svg" alt="Python">
  <img src="https://img.shields.io/badge/Platform-Paradex-green.svg" alt="Platform">
  <img src="https://img.shields.io/badge/License-MIT-yellow.svg" alt="License">
  <img src="https://img.shields.io/badge/Version-2.1-red.svg" alt="Version">
</p>

<p align="center">
  <b>基于研究优化的 Paradex 永续合约交易机器人，支持双向交易</b>
</p>

---

## 核心特性

| 特性 | 描述 |
|------|------|
| **双向交易** | 上涨做多，下跌做空，任何行情都能盈利 |
| **RPI 触发** | 100% 使用市价单(TAKER)，最大化 RPI 获取 |
| **零手续费** | 配合 Interactive Token 实现 0% 交易手续费 |
| **智能平仓** | POST_ONLY 限价单平仓，赚取点差而非支付 |
| **方向预测** | 基于订单簿不平衡度预测短期价格方向 |
| **Kelly仓位** | 动态仓位管理，科学控制风险 |
| **尾随止盈** | 价格有利时自动跟踪，锁定更多利润 |
| **回撤控制** | 自动暂停机制，保护本金安全 |

---

## v2.1 新增: 双向交易

### 核心改进

```
v2.0 (只做多):
  imbalance > +0.3  →  做多
  imbalance < -0.3  →  跳过 ❌ (错过做空机会)

v2.1 (双向交易):
  imbalance > +0.3  →  做多 ✅
  imbalance < -0.3  →  做空 ✅ (下跌也能赚钱)
```

### 双向交易逻辑

| 市场状态 | 订单簿信号 | 操作 | 盈利条件 |
|---------|-----------|------|---------|
| 上涨趋势 | imbalance > +0.3 (买压大) | **做多** | 价格上涨 |
| 下跌趋势 | imbalance < -0.3 (卖压大) | **做空** | 价格下跌 |
| 横盘震荡 | \|imbalance\| < 0.3 | 跳过 | - |

---

## 快速开始

### 1. 环境准备

```bash
# 克隆项目
git clone https://github.com/wuyutanhongyuxin-cell/pp_RPI.git
cd pp_RPI

# 安装依赖
pip install -r requirements.txt
```

### 2. 配置账号

```bash
# 复制配置文件
cp .env.example .env

# 编辑 .env，填入你的私钥和地址
```

### 3. 运行脚本

```bash
python rpi_bot.py
```

---

## 配置说明

### 基础配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `MARKET` | BTC-USD-PERP | 交易市场 |
| `TRADE_SIZE` | 0.001 | 每笔交易大小 (BTC) |
| `TRADE_INTERVAL` | 3.0 | 交易间隔 (秒) |
| `PARADEX_ENVIRONMENT` | prod | 环境 (prod/testnet) |

### 核心风控 (建议不要修改)

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `STOP_LOSS_PCT` | 0.015 | 止损百分比 (0.015%) |
| `RISK_REWARD_RATIO` | 2.0 | 风险收益比，止盈=止损×2 |
| `MAX_SPREAD_PCT` | 0.012 | 最大允许价差 |
| `MAX_WAIT_SECONDS` | 15 | 等待止盈最长时间 |

### 入场策略

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `ENTRY_MODE` | trend | 入场模式: trend/mean_reversion/hybrid |
| `TREND_FILTER` | true | 趋势过滤开关 |
| `DIRECTION_SIGNAL_THRESHOLD` | 0.3 | 方向信号阈值 |
| `VOLATILITY_FILTER` | false | 波动率过滤 (建议关闭) |
| `DYNAMIC_STOP_LOSS` | false | 动态止损 (建议关闭) |

### 高级功能

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `EXIT_ORDER_TYPE` | limit | 平仓模式: limit=限价单(赚点差) |
| `KELLY_ENABLED` | true | Kelly仓位管理 |
| `TRAILING_STOP` | true | 尾随止盈 |
| `DRAWDOWN_CONTROL` | true | 回撤控制 |
| `TIME_FILTER` | true | 时段过滤 |

---

## 策略原理

### 1. 风险收益比 (1:2)

使用 1:2 的风险收益比，大幅降低盈亏平衡所需的胜率：

| 风险收益比 | 所需胜率 | 说明 |
|-----------|---------|------|
| 1:1 | 50%+ | 传统策略 |
| **1:2** | **33%+** | 本策略默认 |
| 1:3 | 25%+ | 激进设置 |

### 2. 订单簿方向信号

```python
imbalance = (买方挂单量 - 卖方挂单量) / (买方挂单量 + 卖方挂单量)

imbalance > +0.3  →  买压大，做多信号
imbalance < -0.3  →  卖压大，做空信号
```

### 3. 双向交易流程

**做多流程:**
```
买压信号 → 确认上涨趋势 → BUY开仓 → 等待价格上涨 → SELL平仓 → 盈利
```

**做空流程:**
```
卖压信号 → 确认下跌趋势 → SELL开仓 → 等待价格下跌 → BUY平仓 → 盈利
```

### 4. 尾随止盈

当价格向有利方向移动时，自动调整止损位置锁定利润：

```
做多示例:
  入场价: $100,000
  初始止损: $99,985 (-0.015%)
  价格涨到: $100,015 (+0.015% = 1R)
  → 尾随激活，止损上移到 $100,007.5
  价格继续涨: $100,030
  → 尾随更新，止损上移到 $100,022.5
  价格回落触发尾随止损 → 平仓盈利
```

### 5. POST_ONLY 限价单平仓

止盈和超时平仓时使用 POST_ONLY 限价单：

- 作为 Maker 可能获得返佣
- 不会产生滑点
- 相当于"赚取"点差
- 止损时仍使用市价单，确保快速出场

---

## 运行日志示例

### 做多示例
```
12:34:56 [INFO] [周期] 开始 RPI 交易周期...
12:34:56 [INFO] [时段] 黄金时段
12:34:56 [INFO] [检查] 余额: 1000.00 USDC
12:34:56 [INFO] [检查] Spread: $5.20 (0.0052%) | 限制: 0.012%
12:34:57 [INFO] [订单簿] 不平衡度: 0.42 | 方向: LONG | 置信度: 0.42
12:34:57 [INFO] [入场] [做多] 趋势上涨+买压: +$12.00, imb=0.42
12:34:57 [INFO] [风险收益] 止盈=0.035% : 止损=0.015% (真实R/R=2.0)
12:34:57 [INFO] [开仓] 做多 市价买入 0.001 BTC @ ~$100005.2...
12:34:57 [INFO]   -> RPI! flags=['rpi']
12:34:57 [INFO] [等待-做多] 止盈: $100040.2 | 止损: $99990.2
12:35:05 [INFO] [止盈] $100042.5 >= $100040.2
12:35:05 [INFO] [平仓] 限价单SELL 0.001 BTC @ $100042.5 (POST_ONLY)...
12:35:06 [INFO]   -> 限价单成交 @ $100042.5
12:35:06 [INFO]   -> PnL: $0.0373 (+0.0373%) | 出场: take_profit
```

### 做空示例
```
12:40:12 [INFO] [周期] 开始 RPI 交易周期...
12:40:12 [INFO] [订单簿] 不平衡度: -0.45 | 方向: SHORT | 置信度: 0.45
12:40:12 [INFO] [入场] [做空] 趋势下跌+卖压: -$8.00, imb=-0.45
12:40:12 [INFO] [开仓] 做空 市价卖出 0.001 BTC @ ~$99980.5...
12:40:12 [INFO]   -> RPI! flags=['rpi']
12:40:12 [INFO] [等待-做空] 止盈: $99945.5 | 止损: $99995.5
12:40:20 [INFO] [止盈] $99942.3 <= $99945.5
12:40:20 [INFO] [平仓] 限价单BUY 0.001 BTC @ $99942.3 (POST_ONLY)...
12:40:21 [INFO]   -> PnL: $0.0382 (+0.0382%) | 出场: take_profit
```

---

## 性能预期

| 指标 | v1.0 | v2.0 | v2.1 |
|-----|-------|------|------|
| 交易方向 | 只做多 | 只做多 | **双向** |
| 胜率要求 | ~57% | ~33% | ~33% |
| 下跌行情 | 亏损 | 跳过 | **盈利** |
| 风险收益比 | ~1:1 | 1:2 | 1:2 |
| 点差成本 | 支付 | 可赚取 | 可赚取 |

---

## 多账号轮换机制

当使用多账号配置时:

```env
PARADEX_ACCOUNTS=0x私钥1,0x地址1;0x私钥2,0x地址2;0x私钥3,0x地址3
```

- 每个账号每小时最多 300 笔交易
- 每个账号每天最多 1000 笔交易
- 当前账号达到限制时自动切换到下一个可用账号
- 所有账号状态自动保存，重启后继续

---

## 如何获取 L2 私钥和地址

### 方法1: 从 Paradex 网页端导出

1. 登录 [Paradex](https://app.paradex.trade/)
2. 点击右上角钱包图标
3. 选择 "Export Private Key"
4. 输入密码验证
5. 复制私钥和地址

### 方法2: 使用 Starknet 钱包

如果你使用 Argent X 或 Braavos 钱包:
1. 在钱包设置中导出私钥
2. 使用对应的 Starknet 地址

---

## 安全退出

按 `Ctrl+C` 可以安全退出，脚本会:

1. 取消所有未完成的挂单
2. 平掉所有持仓
3. 保存账号状态

---

## 常见问题

### Q: 为什么我的交易都是亏损的?

A: 检查以下几点:
1. 确保 `VOLATILITY_FILTER=false` 和 `DYNAMIC_STOP_LOSS=false`
2. 确保在流动性好的时段交易 (UTC 8:00-21:00)
3. 确保网络延迟不要太高

### Q: 做空功能如何工作?

A: 当订单簿不平衡度 < -0.3 (卖压大于买压30%+) 且确认下跌趋势时:
1. SELL 开空仓
2. 等待价格下跌
3. BUY 平仓获利

### Q: 脚本运行时突然断开怎么办?

A: 重新运行脚本即可。脚本会自动:
- 加载之前保存的账号状态
- 清理残留的挂单和仓位
- 继续交易

---

## 更新日志

### v2.1 (2024-02-04) - 双向交易版

**新增功能:**
- 双向交易支持 - 上涨做多，下跌做空
- 做空止盈止损逻辑 - 方向相反
- 做空尾随止盈 - 追踪最低价
- 做空PnL计算 - (入场价-出场价)×数量

**优化:**
- 简化入场条件，提高成功率
- 默认关闭波动率过滤和动态止损

### v2.0 - 研究优化版

- POST_ONLY 限价单平仓功能
- 订单簿方向信号预测
- Kelly 准则仓位管理
- 时段过滤器
- 回撤控制机制
- 尾随止盈功能

### v1.0 - 初始版本

- 基础 RPI 交易功能
- 趋势过滤
- 多账号轮换

---

## 风险提示

1. **市场风险**: 加密货币市场波动剧烈，可能产生超出预期的亏损
2. **策略风险**: 历史表现不代表未来收益，策略可能在某些市场条件下失效
3. **技术风险**: 网络延迟、API故障等可能影响交易执行
4. **资金管理**: 建议使用小资金测试，确认稳定后再增加交易量

## 免责声明

- 本脚本仅供学习和研究使用
- 加密货币交易存在风险，请谨慎使用
- 作者不对使用本脚本造成的任何损失负责

---

## 相关项目

- [pp2](https://github.com/wuyutanhongyuxin-cell/pp2) - 原版 Paradex 狙击机器人

## License

MIT

---

<p align="center">
  <b>如果这个项目对你有帮助，请给个 Star 支持一下!</b>
</p>
